{{>layout/header}}

	<div class="right_col" role="main">
	    <div class="row">
	        <div class="col-md-12">
	            <div class="x_panel">
	                <div class="x_title"> 
	                  <h2>HOME > 메타테이블 관리</h2>
	                  <div class="clearfix"> </div>
	                </div>
	                <div class="x_content">
	                    <div class="col-12 col-md-10">
	                      <div class="form-group row">
	                        <label class="control-label">검색</label>
	                        <div class="form-control_box">
	                          <div class="col-md-2 pl-0">
	                            <select class="form-control" name="l_clsf" id="l_clsf" onchange="dpCmCategory('1', this.value);">
	                                <option value="">대분류</option>
	                            </select>
	                          </div>
	                          <div class="col-md-2 pl-0">
	                            <select class="form-control" name="m_clsf" id="m_clsf" onchange="dpCmCategory('2', this.value);">
	                                <option value="">중분류</option>
	                            </select>
	                          </div>
	                          <div class="col-md-2 pl-0">
	                            <select class="form-control" name="s_clsf" id="s_clsf" onchange="dpCmCategory('3', this.value);">
	                                <option value="">소분류</option>
	                            </select>
	                          </div>
	                          <div class="col-md-2 pl-0">
	                            <select class="form-control" name="search_type" id="search_type">
	                                <option value="dset_korean_nm">데이터셋명</option>
	                                <option value="table_korean_nm">테이블 한글명</option>
	                                <option value="table_eng_nm">테이블 영문명</option>
	                            </select>
	                          </div>
	                          <div class="col-md-4 pr-0">
	                            <input class="form-control" type="text" name="query" id="query" onkeypress="enterkey(event);">
	                          </div>
	                        </div>
	                      </div>
	                    </div>
	                    <div class="col-12 col-md-2 btn_search_box">
	                      <button class="btn btn-primary" onclick="dpIngestMetaTbl();"> <i class="glyphicon glyphicon-search"></i></button>
	                    </div>
	            	</div>
	        	</div>
	    	</div>
		</div>
		<div class="row">
		    <div class="col-md-12">
		        <div class="x_panel">
		            <div class="x_title">
		                <h3>테이블 정보</h3>
		            </div>
		            <div class="x_content">
	                    <div class="table_btns mt-4">
	                    	<button class="btn btn btn-success" type="button">테이블 생성</button>
	                    	<button class="btn btn-primary" type="button" onclick="btnAdd();">추가</button>
	                    	<button class="btn btn-danger" type="button">삭제</button>
                    	</div>
		                <div class="table_responsive">
		                	<div class="talbel_total">총 <span class="red bold" id="total_count"></span>건</div>
		                    <table class="table table-striped" style="text-align: center;">
		                        <colgroup>
		                            <col width="55px">
		                        </colgroup>
		                        <thead>
		                            <tr>
		                                <th rowspan="2">선택</th>
		                                <th rowspan="2">대분류</th>
		                                <th rowspan="2">중분류</th>
		                                <th rowspan="2">소분류</th>
		                                <th rowspan="2">수집방식</th>
		                                <th rowspan="2">수집유형</th>
		                                <th rowspan="2">데이터셋 한글명</th>
		                                <th colspan="2">테이블</th>
		                                <th rowspan="2">수집테이블생성여부</th>
		                                <th rowspan="2">컬럼정보</th>
		                            </tr>
		                            <tr>
		                                <th>한글명</th>
		                                <th>영문명</th>
		                            </tr>
		                        </thead>
		                        <tbody id="metaList">
		                        </tbody>
		                    </table>
		                    <div class="nav justify-content-center"> 
		                      <ul id="pagingul" class="pagination">
							  	</ul> 
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
		<div id="tbl_layer" style="display: none;">
			<div class="row" id="dataset_layer">
			    <div class="col-md-12">
			        <div class="x_panel">
			            <div class="x_title">
			                <h3>데이터셋 항목</h3>
			                <div class="clearfix"> </div>
			            </div>
			            <div class="x_content">
			            	<div class="table_btns mt-4">
		                    	<button class="btn btn-primary" type="button" onclick="metaDsetSaveBtn();">저장</button>
	                    	</div>
	                    	<div class="table_responsive">
			                    <table class="table table-bordered bulk_action table_center">
			                        <colgroup>
			                        </colgroup>
			                        <thead>
			                        <tr>
			                            <th>데이터셋 한글명</th>
			                            <th>
			                                <input class="form-control" type="text" name="dset_korean_nm" id="dset_korean_nm">
			                            </th>
			                            <th>수집 방식</th>
			                            <th>
			                            	<select class="form-control clct_mthd1" name="clct_mthd" id="clct_mthd" disabled>
			                                	<option value="">선택</option>
			                            	</select>
			                            </th>
			                            <th rowspan="3" style="vertical-align: middle;">데이터셋 설명</th>
			                            <th rowspan="3" style="vertical-align: middle;">
			                                <textarea name="dset_dc" id="dset_dc" rows="6" style="width: 100%;"></textarea>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>데이터셋 대분류</th>
			                            <th>
			                                <select class="form-control" name="dset_lclas" id="dset_lclas" onchange="dpCmCategoryDataset('1', this.value);">
			                                	<option value="">선택</option>
			                                </select>
			                            </th>
			                            <th>수집 유형</th>
			                            <th>
			                                <select class="form-control clct_ty1" name="clct_ty" id="clct_ty" disabled>
			                                    <option value="">선택</option>
			                                </select>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>데이터셋 중분류</th>
			                            <th>
			                                <select class="form-control" name="dset_mclas" id="dset_mclas" onchange="dpCmCategoryDataset('2', this.value);">
			                                    <option value="">선택</option>
			                                </select>
			                            </th>
			                            <th>데이터셋 소유자</th>
			                            <th>
			                                <select class="form-control" name="dset_owner" id="dset_owner">
			                                    <option value="S">시스템</option>
			                                    <option value="U">사용자</option>
			                                </select>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>데이터셋 소분류</th>
			                            <th>
			                                <select class="form-control" name="dset_sclas" id="dset_sclas" onchange="dpCmCategoryDataset('3', this.value);">
			                                    <option value="">선택</option>
			                                </select>
			                            </th>
			                            <th>CUD 구분(한자리)</th>
			                            <th>
			                                <select class="form-control" name="crud_se" id="crud_se">
			                                    <option value="C">C</option>
			                                    <option value="U">U</option>
			                                    <option value="D">D</option>
			                                </select>
			                            </th>
			                            <th rowspan="2" style="vertical-align: middle">CUD 설명</th>
			                            <th rowspan="2" style="vertical-align: middle">
			                                <textarea name="crud_dc" id="crud_dc" rows="4" style="width: 100%;"></textarea>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>사용 여부</th>
			                            <th>
			                                <select class="form-control" name="use_at" id="use_at">
			                                    <option value="Y">사용</option>
			                                    <option value="N">미사용</option>
			                                </select>
			                            </th>
			                            <th>수집 테이블 생성 여부</th>
			                            <th>
			                                <input class="form-control" type="text" name="creat_table_at" id="creat_table_at" readonly="readonly">
			                            </th>
			                        </tr>
			                        </thead>
			                        <tbody>
			                        </tbody>
			                    </table>
			                </div>
			            </div>
			        </div>
			    </div>
			</div>
			<div class="row">
			    <div class="col-md-12">
			        <div class="x_panel">
			            <div class="x_title">
			                <h3>테이블 항목</h3>
			                <div class="clearfix"></div>
			            </div>
			            <div class="x_content">
			            	<div class="table_btns mt-4">
		                    	<button class="btn btn-primary" type="button" onclick="metaTblSaveBtn();">저장</button>
	                    	</div>
			                <div class="table_responsive">
			                    <table class="table table-bordered bulk_action table_center">
			                        <colgroup>
			                        </colgroup>
			                        <thead>
			                        <tr>
			                            <th>테이블 한글명</th>
			                            <th colspan="3">
			                                <input class="form-control" type="text" name="table_korean_nm" id="table_korean_nm">
			                            </th>
			                            <th rowspan="3" style="vertical-align: middle;">테이블 설명</th>
			                            <th rowspan="3" style="vertical-align: middle;">
			                                <textarea name="table_dc" id="table_dc" rows="6" style="width: 100%;"></textarea>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>테이블 영문명</th>
			                            <th colspan="3">
			                            	<div class="form-control_box duplicate_box">
			                                <input class="form-control" type="text" name="table_eng_nm" id="table_eng_nm" oninput="handleOnInput(this);">
			                                <button class="btn btn-danger btn-sm" onclick="dpIngestMetaTblChk();">중복조회</button>
			                                </div>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>데이터셋 종류</th>
			                            <th>
			                                <select class="form-control" name="dset_knd" id="dset_knd">
			                                    <option value="D">데이터</option>
			                                    <option value="M">메타정보</option>
			                                </select>
			                            </th>
			                            <th>소유자 ID</th>
			                            <th>
			                                <select class="form-control" name="table_owner" id="table_owner">
			                                    <option value="S">시스템</option>
			                                    <option value="U">사용자</option>
			                                </select>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>테이블 유형</th>
			                            <th>
			                                <select class="form-control" name="physic_table_ty" id="physic_table_ty">
			                                    <option value="마스터테이블">마스터테이블</option>
			                                    <option value="일반테이블">일반테이블</option>
			                                    <option value="메타테이블">메타테이블</option>
			                                </select>
			                            </th>
			                            <th>CUD 구분(한자리)</th>
			                            <th>
			                                <select class="form-control" name="crud_se2" id="crud_se2">
			                                    <option value="C">C</option>
			                                    <option value="U">U</option>
			                                    <option value="D">D</option>
			                                </select>
			                            </th>
			                            <th rowspan="2" style="vertical-align: middle">CUD 설명</th>
			                            <th rowspan="2" style="vertical-align: middle">
			                                <textarea name="crud_dc2" id="crud_dc2" rows="4" style="width: 100%;"></textarea>
			                            </th>
			                        </tr>
			                        <tr>
			                            <th>사용 여부</th>
			                            <th>
			                                <select class="form-control" name="use_at2" id="use_at2">
			                                    <option value="Y">사용</option>
			                                    <option value="N">미사용</option>
			                                </select>
			                            </th>
			                            <th>수집 테이블 생성 여부</th>
			                            <th>
			                                <input class="form-control" type="text" name="creat_table_at2" id="creat_table_at2" readonly="readonly">
			                            </th>
			                        </tr>
			                        </thead>
			                        <tbody>
			                        </tbody>
			                    </table>
			                </div>
			            </div>
			        </div>
			    </div>
			</div>
		</div>
	</div>
	<input type="hidden" name="rl_dset_idntfc_id" id="rl_dset_idntfc_id"/>
	<input type="hidden" name="dset_idntfc_id" id="dset_idntfc_id"/>
	<input type="hidden" name="table_idntfc_id" id="table_idntfc_id"/>
	<input type="hidden" name="btn_type" id="btn_type"/>
	<input type="hidden" name="temp_table_eng_nm" id="temp_table_eng_nm"/>
        
{{>layout/footer}}        

<script>

const commonUrl = '/common';
const url = '/metaTable';

let init_page = 1;				//초기 페이지
let page = 1;					//페이지
let init_size_per_page = 10;	//초기 개수
let size_per_page = 10;	 		//가져올 개수
let pageCount = 10;		 		//페이징에 나타낼 페이지 수

let duplicateYn = '';		//중복 체크 여부

//테이블 영문명 변경시 중복 체크 값 초기화
$('#table_eng_nm').on('keyup', function(){
	duplicateYn = '';
});

//분류 조회(검색 영역)
const dpCmCategory = function (clsf_type, clsf_id) {
	
	let paramStr = '';
	if(clsf_id){
		paramStr = 'clsf_id='+clsf_id;
	}
	
	const data = {
   		url: '/dp/cm/category?'+paramStr,
    };
	
    $.ajax({
        type: 'POST',
        url: commonUrl+'/dpCmCategory',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		 if(clsf_type == '1'){	//대분류 선택시
		  		$("#m_clsf option:gt(0)").remove();
		  		$("#s_clsf option:gt(0)").remove();
		  	  }else if(clsf_type == '2'){	//중분류 선택시
		  		$("#s_clsf option:gt(0)").remove();
		  	  }else if(clsf_type == '3'){	//소분류 선택시
		  	  }else{	//초기 호출
		  		$("#l_clsf option:gt(0)").remove();
		  		$("#m_clsf option:gt(0)").remove();
		  		$("#s_clsf option:gt(0)").remove();
		  	  }
  	    	if(data.contents != ""){
  	    		let insertTr = '';
		  	    $.each(data.contents, function (idx, el) {
		  	    	let clsf_nm = el.clsf_nm;
		  	    	if(clsf_nm.lastIndexOf('-') > -1){
		  	    		clsf_nm = clsf_nm.substring(clsf_nm.lastIndexOf('-')+1);
		  	    	}
		  	    	insertTr += '<option value="'+el.clsf_id+'">'+clsf_nm+'</option>';
		  	    });
		  	  if(clsf_type == '1'){	//대분류 선택시
		  	  	$("#m_clsf").append(insertTr);
		  	  }else if(clsf_type == '2'){	//중분류 선택시
		  		$("#s_clsf").append(insertTr);
		  	  }else if(clsf_type == '3'){	//소분류 선택시
		  	  }else{
		  		$("#l_clsf").append(insertTr);
		  	  }
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분류 조회(추가시 데이터셋 항목 영역)
const dpCmCategoryDataset = function (clsf_type, clsf_id) {
	
	let paramStr = '';
	if(clsf_id){
		paramStr = 'clsf_id='+clsf_id;
	}
	
	const data = {
   		url: '/dp/cm/category?'+paramStr,
    };
	
    $.ajax({
        type: 'POST',
        url: commonUrl+'/dpCmCategoryDataset',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
        async: false,
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		 if(clsf_type == '1'){	//대분류 선택시
		  		$("#dset_mclas option:gt(0)").remove();
		  		$("#dset_sclas option:gt(0)").remove();
		  	  }else if(clsf_type == '2'){	//중분류 선택시
		  		$("#dset_sclas option:gt(0)").remove();
		  	  }else if(clsf_type == '3'){	//소분류 선택시
		  	  }else{	//초기 호출
		  		$("#dset_lclas option:gt(0)").remove();
		  		$("#dset_mclas option:gt(0)").remove();
		  		$("#dset_sclas option:gt(0)").remove();
		  	  }
  	    	if(data.contents != ""){
  	    		let insertTr = '';
		  	    $.each(data.contents, function (idx, el) {
		  	    	let clsf_nm = el.clsf_nm;
		  	    	if(clsf_nm.lastIndexOf('-') > -1){
		  	    		clsf_nm = clsf_nm.substring(clsf_nm.lastIndexOf('-')+1);
		  	    	}
		  	    	insertTr += '<option value="'+el.clsf_id+'">'+clsf_nm+'</option>';
		  	    });
		  	  if(clsf_type == '1'){	//대분류 선택시
		  	  	$("#dset_mclas").append(insertTr);
		  	  }else if(clsf_type == '2'){	//중분류 선택시
		  		$("#dset_sclas").append(insertTr);
		  	  }else if(clsf_type == '3'){	//소분류 선택시
		  	  }else{
		  		$("#dset_lclas").append(insertTr);
		  	  }
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//메타테이블 목록 조회
const dpIngestMetaTbl = function (page, size_per_page) {
	
	if(!page){
		page = init_page;
	}
	if(!size_per_page){
		size_per_page = init_size_per_page;
	}	
	
	let search_type = $("#search_type").val();
	let query = $("#query").val();
	let l_clsf = $("#l_clsf").val();
	let m_clsf = $("#m_clsf").val();
	let s_clsf = $("#s_clsf").val();
	
	const data = {
   		url: '/dp/ingest/meta/tables',
   		user_id: 'user00',	
   		search_type: search_type,
   		search: query,
   		dset_lclas: l_clsf,
   		dset_mclas: m_clsf,
   		dset_sclas: s_clsf,
   		page_current: String(page),
    };
	
    $.ajax({
        type: 'POST',
        url: url+'/dpIngestMetaTbl',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#metaList").empty();
	  		$("#total_count").text(data.totalcount);
  	    	if(data.contents != ""){
  	    		let insertTr = '';
		  	    $.each(data.contents, function (idx, el) {
		  	    	let dset_mclas = el.dset_mclas;
		  	    	let dset_sclas = el.dset_sclas;
		  	    	
		  	    	if(dset_mclas){
		  	    		if(dset_mclas.lastIndexOf('-') > -1){
			  	    		dset_mclas = dset_mclas.substring(dset_mclas.lastIndexOf('-')+1);
			  	    	}
		  	    	}
		  	    	
		  	    	if(dset_sclas){
		  	    		if(dset_sclas.lastIndexOf('-') > -1){
			  	    		dset_sclas = dset_sclas.substring(dset_sclas.lastIndexOf('-')+1);
			  	    	}
		  	    	}
		  	    	
		  	    	insertTr += '<tr>';
		  	    	insertTr += '	<td><input type="checkbox"></td>';
		  	    	insertTr += '	<td>'+isEmpty(el.dset_lclas)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(dset_mclas)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(dset_sclas)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(el.clct_mthd)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(el.clct_ty)+'</td>';
		  	    	insertTr += '	<td><span class="blue bold" style="cursor:pointer" onclick="dpIngestMetaDetail(\''+el.rl_dset_idntfc_id+'\', \''+el.table_idntfc_id+'\');">'+isEmpty(el.dset_korean_nm)+'</span></td>';
		  	    	insertTr += '	<td>'+isEmpty(el.table_korean_nm)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(el.table_eng_nm)+'</td>';
		  	    	insertTr += '	<td>'+isEmpty(el.creat_table_at)+'</td>';
		  	    	insertTr += '	<td><button class="btn btn-success btn-sm mx-0" type="button" onclick="columnInfoList(\''+el.table_idntfc_id+'\');">바로가기</button></td>';
		  	    	insertTr += '</tr>';
		  	    });
		  	  $("#metaList").html(insertTr);
  	    	}
  	    	//페이징 보여줌
  	    	paging(data.totalcount, size_per_page, pageCount, page);
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//메타테이블 데이터셋 항목 상세
const dpIngestMetaTblDset = function (dset_idntfc_id) {
	
	const data = {
   		url: '/dp/ingest/meta/tables/dataset',
   		user_id: 'user00',	
   		dset_idntfc_id: dset_idntfc_id,
    };
	
    $.ajax({
        type: 'POST',
        url: url+'/dpIngestMetaTblDset',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
    }).done(function (data) {
	  	  if (data != null) {
  	    	if(data.contents != ""){
  	    		$("#dset_idntfc_id").val(dset_idntfc_id);
	  	    	$("#dset_korean_nm").val(data.contents[0].dset_korean_nm);
	  	    	$("#clct_mthd").val(data.contents[0].clct_mthd);
	  	    	$("#dset_dc").val(data.contents[0].dset_dc);
	  	    	$("#clct_ty").val(data.contents[0].clct_ty);
	  	    	$("#dset_owner").val(data.contents[0].dset_owner).prop("selected", true);
	  	    	$("#crud_se").val(data.contents[0].crud_se).prop("selected", true);
	  	    	$("#crud_dc").val(data.contents[0].crud_dc);
	  	    	$("#use_at").val(data.contents[0].use_at).prop("selected", true);
	  	    	$("#creat_table_at").val(data.contents[0].creat_table_at);
	  	    	
	  	    	let dset_lclas = data.contents[0].dset_lclas;
	  	    	let dset_mclas = data.contents[0].dset_mclas;
	  	    	let dset_sclas = data.contents[0].dset_sclas;
	  	    	
  	    		dpCmCategoryDataset();
  	    		$("#dset_lclas").val(dset_lclas).prop("selected", true);
  	    		
	  	    	if(dset_mclas){
	  	    		dpCmCategoryDataset('1', dset_lclas);
	  	    		$("#dset_mclas").val(dset_mclas).prop("selected", true);
	  	    	}
	  	    	if(dset_sclas){
	  	    		dpCmCategoryDataset('2', dset_mclas);
	  	    		$("#dset_sclas").val(dset_sclas).prop("selected", true);
	  	    	}
  	    	}
	  	  }
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//메타테이블 항목 상세
const dpIngestMetaTblTbl = function (table_idntfc_id) {
	
	const data = {
   		url: '/dp/ingest/meta/tables/table',
   		user_id: 'user00',	
   		table_idntfc_id: table_idntfc_id,
    };
	
    $.ajax({
        type: 'POST',
        url: url+'/dpIngestMetaTblTbl',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
	  	  if (data != null) {
  	    	if(data.contents != ""){
  	    		$("#table_idntfc_id").val(table_idntfc_id);
	  	    	$("#table_korean_nm").val(data.contents[0].table_korean_nm);
	  	    	$("#table_eng_nm").val(data.contents[0].table_eng_nm);
	  	    	$("#temp_table_eng_nm").val(data.contents[0].table_eng_nm);
	  	    	$("#dset_knd").val(data.contents[0].dset_knd).prop("selected", true);
	  	    	$("#table_owner").val(data.contents[0].table_owner).prop("selected", true);
	  	    	$("#physic_table_ty").val(data.contents[0].physic_table_ty).prop("selected", true);
	  	    	$("#crud_se2").val(data.contents[0].crud_se).prop("selected", true);
	  	    	$("#crud_dc2").val(data.contents[0].crud_dc);
	  	    	$("#use_at2").val(data.contents[0].use_at).prop("selected", true);
	  	    	$("#creat_table_at2").val(data.contents[0].creat_table_at);
  	    	}
	  	  }
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//메타테이블 데이터셋 등록
const dpIngestMetaTblSaveDset = function (){
	let dset_korean_nm = $('#dset_korean_nm').val();
	let dset_lclas = $('#dset_lclas').val();
	let dset_mclas = $('#dset_mclas').val();
	let dset_sclas = $('#dset_sclas').val();
	let use_at = $('#use_at').val();
	let clct_mthd = $('#clct_mthd').val();
	let clct_ty = $('#clct_ty').val();
	let dset_owner = $('#dset_owner').val();
	let crud_se = $('#crud_se').val();
	let creat_table_at = $('#creat_table_at').val();
	let dset_dc = $('#dset_dc').val();
	let crud_dc = $('#crud_dc').val();
	
	if(!dset_korean_nm){
		alert("데이터셋 한글명을 입력하세요!");
		$('#dset_korean_nm').focus();
		return;
	}
	
	const data = {
   		url: '/dp/ingest/meta/tables/save/dataset',
   		user_id: 'user00',
   	    dset_owner: dset_owner,
   	    dset_lclas: dset_lclas,
   	    dset_mclas: dset_mclas,
   	    dset_sclas: dset_sclas,
   	    clct_mthd: 'openapi',
   	    clct_ty: 'POSTGRESQL',
   	    logic_db_nm: 'LX_DT_DMS',
   	    dset_korean_nm: dset_korean_nm,
   	    dset_dc: dset_dc,
   	    idntfr: null,
   	    supe_type_entity_nm: null,
   	    entity_iem_nm: null,
   	    crud_se: crud_se,
   	    crud_dc: crud_dc,
    };
	
	if(confirm("등록 하시겠습니까?")){
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestMetaTblSaveDset',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data),
	    }).done(function (data) {
	  		$("#rl_dset_idntfc_id").val(data.contents[0].dset_idntfc_id);
	  		alert("저장 되었습니다.");
	  		dpIngestMetaTbl();
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
	
}

//메타테이블 테이블 등록
const dpIngestMetaTblSaveTbl = function (){
	let table_korean_nm = $('#table_korean_nm').val();
	let table_eng_nm = $('#table_eng_nm').val().toLowerCase();
	let dset_knd = $('#dset_knd').val();
	let table_owner = $('#table_owner').val();
	let physic_table_ty = $('#physic_table_ty').val();
	let crud_se2 = $('#crud_se2').val();
	let use_at2 = $('#use_at2').val();
	let table_dc = $('#table_dc').val();
	let crud_dc2 = $('#crud_dc2').val();
	let rl_dset_idntfc_id = $('#rl_dset_idntfc_id').val();
	
	if(!table_korean_nm){
		alert("테이블 한글명을 입력하세요!");
		$('#table_korean_nm').focus();
		return;
	}
	
	if(!table_eng_nm){
		alert("테이블 영문명을 입력하세요!");
		$('#table_eng_nm').focus();
		return;
	}
	
	if(!rl_dset_idntfc_id){
		alert("선택된 데이터셋 항목이 없습니다.");
		return;
	}
	
	if(duplicateYn != 'N'){
		if(duplicateYn == 'Y'){
			alert("동일한 테이블 영문명이 있습니다.");
		}else{
			alert("중복 체크를 해주세요.");
		}
		$("#table_eng_nm").focus();
		return;
	}
	
	const data = {
		url: '/dp/ingest/meta/tables/save/table',
		user_id: 'user00',
	    rl_dset_idntfc_id: rl_dset_idntfc_id,
	    dset_knd: dset_knd,
	    physicl_db_nm: 'LX_DT_DBS',
	    table_owner: table_owner,
	    table_eng_nm: table_eng_nm,
	    table_korean_nm: table_korean_nm,
	    physic_table_ty: physic_table_ty,
	    rl_entity_idntfc_id: null,
	    table_dc: table_dc,
	    cl_systm: null,
	    prsrv_pd: null,
	    table_volum: null,
	    occrrnc_cycle: null,
	    othbc_at: null,
	    iem_nm: null,
	    crud_se: crud_se2,
	    crud_dc: crud_dc2,
		use_at: use_at2,
    };
	
	if(confirm("등록 하시겠습니까?")){
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestMetaTblSaveTbl',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data),
	    }).done(function (data) {
	  		alert("저장 되었습니다.");   	
	  		dpIngestMetaTbl();
	  		
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
	
}

//메타테이블 데이터셋 수정
const dpIngestMetaTblUpdateDset = function (){
	let dset_korean_nm = $('#dset_korean_nm').val();
	let dset_lclas = $('#dset_lclas').val();
	let dset_mclas = $('#dset_mclas').val();
	let dset_sclas = $('#dset_sclas').val();
	let use_at = $('#use_at').val();
	let clct_mthd = $('#clct_mthd').val();
	let clct_ty = $('#clct_ty').val();
	let dset_owner = $('#dset_owner').val();
	let crud_se = $('#crud_se').val();
	let creat_table_at = $('#creat_table_at').val();
	let dset_dc = $('#dset_dc').val();
	let crud_dc = $('#crud_dc').val();
	let dset_idntfc_id = $('#dset_idntfc_id').val();
	
	if(!dset_korean_nm){
		alert("데이터셋 한글명을 입력하세요!");
		$('#dset_korean_nm').focus();
		return;
	}
	
	const data = {
   		url: '/dp/ingest/meta/tables/update/dataset',
   		user_id: 'user00',
   	    dset_owner: dset_owner,
   	    dset_lclas: dset_lclas,
   	    dset_mclas: dset_mclas,
   	    dset_sclas: dset_sclas,
   	    clct_mthd: 'openapi',
   	    clct_ty: 'POSTGRESQL',
   	    logic_db_nm: 'LX_DT_DMS',
   	    dset_korean_nm: dset_korean_nm,
   	    dset_dc: dset_dc,
   	    idntfr: null,
   	    supe_type_entity_nm: null,
   	    entity_iem_nm: null,
   	    crud_se: crud_se,
   	    crud_dc: crud_dc,
   	 	dset_idntfc_id: dset_idntfc_id,
   	 	use_at: use_at,
   	 	creat_table_at: creat_table_at,
    };
	
	if(confirm("수정 하시겠습니까?")){
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestMetaTblUpdateDset',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data),
	    }).done(function (data) {
	  		alert("수정 되었습니다.");
	  		dpIngestMetaTbl();
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
	
}

//메타테이블 테이블 수정
const dpIngestMetaTblUpdateTbl = function (){
	let table_korean_nm = $('#table_korean_nm').val();
	let table_eng_nm = $('#table_eng_nm').val().toLowerCase();
	let temp_table_eng_nm = $('#temp_table_eng_nm').val().toLowerCase();
	let dset_knd = $('#dset_knd').val();
	let table_owner = $('#table_owner').val();
	let physic_table_ty = $('#physic_table_ty').val();
	let crud_se2 = $('#crud_se2').val();
	let use_at2 = $('#use_at2').val();
	let table_dc = $('#table_dc').val();
	let crud_dc2 = $('#crud_dc2').val();
	let rl_dset_idntfc_id = $('#dset_idntfc_id').val();
	let table_idntfc_id = $('#table_idntfc_id').val();
	let creat_table_at2 = $('#creat_table_at2').val();
	
	if(!table_korean_nm){
		alert("테이블 한글명을 입력하세요!");
		$('#table_korean_nm').focus();
		return;
	}
	
	if(!table_eng_nm){
		alert("테이블 영문명을 입력하세요!");
		$('#table_eng_nm').focus();
		return;
	}
	
	if(!rl_dset_idntfc_id){
		alert("선택된 데이터셋 항목이 없습니다.");
		return;
	}
	
	if(table_eng_nm == temp_table_eng_nm){
		duplicateYn = 'N';
	}
	
	if(duplicateYn != 'N'){
		if(duplicateYn == 'Y'){
			alert("동일한 테이블 영문명이 있습니다.");
		}else{
			alert("중복 체크를 해주세요.");
		}
		$("#table_eng_nm").focus();
		return;
	}
	
	const data = {
		url: '/dp/ingest/meta/tables/update/table',
		user_id: 'user00',
	    rl_dset_idntfc_id: rl_dset_idntfc_id,
	    dset_knd: dset_knd,
	    physicl_db_nm: 'LX_DT_DBS',
	    table_owner: table_owner,
	    table_eng_nm: table_eng_nm,
	    table_korean_nm: table_korean_nm,
	    physic_table_ty: physic_table_ty,
	    rl_entity_idntfc_id: null,
	    table_dc: table_dc,
	    cl_systm: null,
	    prsrv_pd: null,
	    table_volum: null,
	    occrrnc_cycle: null,
	    othbc_at: null,
	    iem_nm: null,
	    crud_se: crud_se2,
	    crud_dc: crud_dc2,
		use_at: use_at2,
		table_idntfc_id: table_idntfc_id,
		creat_table_at: creat_table_at2,
    };
	
	if(confirm("수정 하시겠습니까?")){
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestMetaTblUpdateTbl',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data),
	    }).done(function (data) {
	  		alert("수정 되었습니다.");   	
	  		dpIngestMetaTbl();
	  		
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
	
}

//테이블 중복체크
const dpIngestMetaTblChk = function (){
	let table_eng_nm = $('#table_eng_nm').val().toLowerCase();
	let temp_table_eng_nm = $('#temp_table_eng_nm').val().toLowerCase();
	
	if(!table_eng_nm){
		alert("테이블 영문명을 입력하세요!");
		$('#table_korean_nm').focus();
		return;
	}
	
	const data = {
		url: '/dp/ingest/meta/tables/check',
		user_id: 'user00',
		table_eng_nm: table_eng_nm,
    };
	
    $.ajax({
        type: 'POST',
        url: url+'/dpIngestMetaTblChk',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
    }).done(function (data) {
    	if(data.contents[0].successYN == 'N'){
 	   		duplicateYn = 'Y';
	   		alert("동일한 테이블 영문명이 있습니다.");
	   		$("#table_eng_nm").focus();
 	   	}else{
	 	   	duplicateYn = 'N';
	   		alert("사용 가능합니다.");
 	   	}
  		
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
	
}

//메타 항목 상세
const dpIngestMetaDetail = function (rl_dset_idntfc_id, table_idntfc_id) {
	btnDetail();
	dpIngestMetaTblDset(rl_dset_idntfc_id);
	dpIngestMetaTblTbl(table_idntfc_id);
}

//메타데이터셋 저장 버튼
const metaDsetSaveBtn = function () {
	let type = $("#btn_type").val();
	if(type == 'U'){
		dpIngestMetaTblUpdateDset()
	}else{
		dpIngestMetaTblSaveDset();
	}
	
}

//메타테이블 저장 버튼
const metaTblSaveBtn = function () {
	let type = $("#btn_type").val();
	if(type == 'U'){
		dpIngestMetaTblUpdateTbl();
	}else{
		dpIngestMetaTblSaveTbl();
	}
}

//추가 버튼
const btnAdd = function(){
	$("#btn_type").val('I');
	if($("#tbl_layer").css("display") == "none"){
	    $("#tbl_layer").show();
	    dpCmCategoryDataset();
	    initDetail();
	    let offset = $('#dataset_layer').offset();
	    $('html').animate({scrollTop : offset.top}, 300);
	} else {
	    $("#tbl_layer").hide();
	}
}

//상세 버튼
const btnDetail = function(){
	$("#btn_type").val('U');
	$("#tbl_layer").show();
    let offset = $('#dataset_layer').offset();
    $('html').animate({scrollTop : offset.top}, 300);
}

//상세 초기화
const initDetail = function(){
	$("#dset_idntfc_id").val("");
  	$("#dset_korean_nm").val("");
  	$("#clct_mthd").val("");
  	$("#dset_dc").val("");
  	$("#clct_ty").val("");
  	$("#dset_owner").val("S").prop("selected", true);
  	$("#crud_se").val("C").prop("selected", true);
  	$("#crud_dc").val("");
  	$("#use_at").val("Y").prop("selected", true);
  	$("#creat_table_at").val("");
  	
  	$("#table_idntfc_id").val("");
  	$("#table_korean_nm").val("");
  	$("#table_eng_nm").val("");
  	$("#temp_table_eng_nm").val("");
  	$("#dset_knd").val("D").prop("selected", true);
  	$("#table_owner").val("S").prop("selected", true);
  	$("#physic_table_ty").val("M").prop("selected", true);
  	$("#crud_se2").val("C").prop("selected", true);
  	$("#crud_dc2").val("");
  	$("#use_at2").val("Y").prop("selected", true);
  	$("#creat_table_at2").val("");
  	
}

const columnInfoList = function(tableIdntfcId){
	location.href = url+'/columnInfo/'+tableIdntfcId;
}

//페이징 함수 호출
const pagingFun = function(page, size_per_page){
	dpIngestMetaTbl(page, size_per_page);
}

//엔터키가 눌렸을 때
const enterkey = function(e) {
	if (e.keyCode == 13) {
		dpIngestMetaTbl();
    }
}

//분류 조회
dpCmCategory();

//수집오류 목록 조회
dpIngestMetaTbl();

</script>

